<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FDIndex</title>
    <link rel="icon" href="data:;base64,=" type="image/x-icon">
    <style>
        html {
            overflow-y: scroll;
            background-color: #CEEACAFF;
        }

        body {
            margin: 80px 0 0;
            font-family: Arial, sans-serif;
        }

        .banner {
            display: flex;
            align-items: center;
            background-color: #1976D2;
            color: white;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            padding: 2px 16px 2px 6px;

            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .banner-left {
            display: flex;
            align-items: center;
            padding: 6px;
            width: 100%;
        }

        .home {
            min-width: 32px;
            font-size: 22px;
            height: auto;
            /*margin: 7px 0px 7px 0px;*/
        }

        .home a {
            text-decoration: none;
            color: inherit;
            width: 100%;
            pointer-events: none;
        }

        #home-click {
            pointer-events: auto;
            width: 100%;
            /*padding: 0;*/
            user-select: none;
            cursor: pointer;
            padding: 9px 0px 9px 0px;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        #home-click:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        #home-click:active {
            background-color: rgba(0, 0, 0, 0.6);
        }

        #home-click span {
            pointer-events: none;
        }

        .home span {
            width: 100%;
            /*border: 1px solid #ffe222;*/
        }

        .banner svg {
            fill: white;
            padding: 0;
            margin: 0;
            height: 10px;
        }

        .blank {
            width: 12px;
        }

        .paths {
            display: flex;
            align-items: center;
            gap: 0px;
            padding: 0;
            margin: 0;
            height: auto;
            font-size: 14px;
        }

        .path {
            padding: 0;
            margin: 0;
            display: flex;
            height: auto;
            align-items: center;
            gap: 0px;
        }

        .path a {
            text-decoration: none;
            color: inherit;
            width: 100%;
            pointer-events: none;
        }

        .path-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='10 7 5 10'><path fill='%23FFFFFF' d='M10,17L15,12L10,7V17Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 10px;
            height: 10px;
            display: inline-block;
        }

        .path span {
            pointer-events: auto;
            padding: 12px 10px 12px 10px;
            /*border: 1px solid #ffe222;*/
            user-select: none;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        .path span:hover {
            background-color: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .path span:active {
            background-color: rgba(0, 0, 0, 0.5);
            transform: scale(1);
        }

        .banner-right {
            height: auto;
            padding-right: 18px;
        }

        .banner-button-right {
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .banner-button-right a {
            background-color: transparent;
            border: none;
            width: 44px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        .banner-button-right a:hover {
            background-color: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .banner-button-right a:active {
            background-color: rgba(0, 0, 0, 0.5);
            transform: scale(1);
        }

        .banner-button-right a svg {
            width: 70%;
            height: 70%;
        }

        .body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
            max-width: 720px;
            padding: 0 14px 24px 14px;
            box-sizing: border-box;
        }

        .action {
            margin: 0 6px 12px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action button {
            color: white;
            background-color: #1976D2;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 10px 14px 10px 14px;
            transition: transform 0.1s ease, background-color 0.1s ease;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.4);
        }

        .action button:hover {
            background-color: #2088ee;
        }

        .action button:active {
            background-color: #165ba6;
        }

        .list-box {
            width: 100%;
            max-width: 720px;
            min-height: 400px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        #progress-bar {
            width: 100%;
            background-color: #c6d8ef;
            border: 0px solid #ccc;
            height: 4px;
            /*display: none; */
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            position: relative;
        }

        #progress {
            height: 100%;
            background-color: #1976D2;
            width: 0%;
            /*!*animation: progressAnimation 2s infinite;*!*/
            /*animation: slidingBar 1200ms infinite;*/
            /*animation-timing-function: cubic-bezier(0.2, 1, 0.8, 1);*/
        }

        #progress-bar-upload {
            width: 100%;
            background-color: #f3f3f3;
            border: 0px solid #ccc;
            height: 8px;
            /*display: none; */
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            position: relative;
        }

        #progress-upload {
            height: 100%;
            background-color: #1976D2;
            width: 0%;
            /*!*animation: progressAnimation 2s infinite;*!*/
            /*animation: slidingBar-upload 1200ms infinite;*/
            /*animation-timing-function: cubic-bezier(0.2, 1, 0.8, 1);*/
        }

        .sliding-bar-animation {
            animation: slidingBar 1200ms infinite;
            animation-timing-function: cubic-bezier(0.2, 1, 0.8, 1);
        }

        @keyframes progressAnimation {
            0% {
                width: 0;
            }
            100% {
                width: 100%;
            }
        }

        @keyframes slidingBar {
            0% {
                transform: translateX(-100%); /* 从容器左边外侧开始 */
            }
            100% {
                transform: translateX(333%); /* 移动到容器右边外侧 */
            }
        }

        .item {
            height: 60px;
            color: black;
            background-color: #CEEACA;
        }

        .item a {
            text-decoration: none;
            color: inherit;
            width: 100%;
            pointer-events: none;
        }

        .item-content {
            pointer-events: auto;
            height: 100%;
            transition: transform 0.1s ease, background-color 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px 14px 0px 12px;
            gap: 6px;
        }

        .file .item-content {
            /*padding: 10px 14px 10px 14px;*/
        }

        .file .item-content:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .folder .item-content {
            cursor: pointer;
            /*padding: 10px 14px 10px 14px;*/
        }

        .folder .item-content:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .folder .item-content:active {
            background-color: rgba(0, 0, 0, 0.12);
        }

        .item-content span {
            user-select: none;
        }

        .item-icon {
            pointer-events: none;
        }

        .file .item-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23737373' d='M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 34px;
            height: 34px;
            display: inline-block;
        }

        .file.symlink .item-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23737373' d='M23 19L20 16V18H16V20H20V22L23 19M13 19C13 18.7 13 18.3 13.1 18H6V16H13.8C14.3 15.2 14.9 14.5 15.7 14H6V12H18V13.1C18.3 13 18.7 13 19 13S19.7 13 20 13.1V8L14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H13.8C13.3 21.1 13 20.1 13 19M13 3.5L18.5 9H13V3.5Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 34px;
            height: 34px;
            display: inline-block;
        }

        .folder .item-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23737373' d='M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 32px;
            height: 32px;
            display: inline-block;
        }

        .folder.symlink .item-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23737373' d='M13 19C13 19.34 13.04 19.67 13.09 20H4C2.9 20 2 19.11 2 18V6C2 4.89 2.89 4 4 4H10L12 6H20C21.1 6 22 6.89 22 8V13.81C21.12 13.3 20.1 13 19 13C15.69 13 13 15.69 13 19M23 19L20 16V18H16V20H20V22L23 19Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 32px;
            height: 32px;
            display: inline-block;
        }

        .item-action button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        .item-action button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .item-action button:active {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .file .item-action-download-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%232196F3' d='M14,2H6C4.89,2 4,2.89 4,4V20C4,21.11 4.89,22 6,22H18C19.11,22 20,21.11 20,20V8L14,2M12,19L8,15H10.5V12H13.5V15H16L12,19M13,9V3.5L18.5,9H13Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 22px;
            height: 22px;
            display: inline-block;
        }

        .item-action-rename-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23E68920' d='M15 16L11 20H21V16H15M12.06 7.19L3 16.25V20H6.75L15.81 10.94L12.06 7.19M18.71 8.04C19.1 7.65 19.1 7 18.71 6.63L16.37 4.29C16.17 4.09 15.92 4 15.66 4C15.41 4 15.15 4.1 14.96 4.29L13.13 6.12L16.88 9.87L18.71 8.04Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 22px;
            height: 22px;
            display: inline-block;
        }

        .item-action-trash-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23F44336' d='M15 13H16.5V15.82L18.94 17.23L18.19 18.53L15 16.69V13M23 16C23 19.87 19.87 23 16 23C14.09 23 12.36 22.24 11.1 21H8C6.9 21 6 20.1 6 19V7H18V9.29C20.89 10.15 23 12.83 23 16M16 11C13.24 11 11 13.24 11 16C11 18.76 13.24 21 16 21C18.76 21 21 18.76 21 16C21 13.24 18.76 11 16 11M19 4V6H5V4H8.5L9.5 3H14.5L15.5 4H19Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 22px;
            height: 22px;
            display: inline-block;
        }

        .item-action-delete-icon {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23E50D0D' d='M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8.46,11.88L9.87,10.47L12,12.59L14.12,10.47L15.53,11.88L13.41,14L15.53,16.12L14.12,17.53L12,15.41L9.88,17.53L8.47,16.12L10.59,14L8.46,11.88M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z'/></svg>");
            background-repeat: no-repeat;
            background-size: contain;
            width: 22px;
            height: 22px;
            display: inline-block;
        }

        .item-info {
            pointer-events: none;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            gap: 2px;

        }

        .item-name {
            font-size: 15px;
        }

        .item-meta {
            font-size: 13px;
            color: #666666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .item-action {
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .item-action button a {
            pointer-events: auto;
        }

        .item-action button i {
            margin: 4px;
            pointer-events: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center; /* flex-start*/
            justify-content: flex-start;
            z-index: 1001;
            /*padding-top: 160px;*/
        }

        .dialog-margin-top {
            width: 100%;
            height: 26%;
            pointer-events: none;
        }

        .dialog {
            background-color: #CEEACA;
            padding: 20px;
            margin-left: 20px;
            margin-right: 20px;
            border-radius: 4px;
            border: 3px dashed #00000000;
            width: auto;
            min-width: 300px;
            max-width: 460px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            /*transform: translateY(-30%);*/
        }

        div#tipbox-disallowed-upload {
            width: 100%;
            margin-top: 2px;
        }

        div#tipbox-current-url {
            width: 100%;
            margin-top: 4px;
        }

        div#tipbox-disallowed-upload span, div#tipbox-current-url span {
            font-size: 12px;
            color: #a2a2a2;
            text-align: left;
            display: block;
            /*white-space: nowrap;*/
            overflow: hidden;
            text-overflow: ellipsis;
        }

        div#upload-file-name {
            margin-top: 18px;
            gap: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-right: 26px;
        }

        label#label-upload-file-name {
            font-size: 14px;
        }

        input#input-upload-file-name {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        .file-input {
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
            cursor: pointer;
        }

        .upload-btn {
            margin-top: 20px;
            padding: 10px;
            width: 100%;
            background-color: #1976D2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }

        .upload-btn:hover {
            background-color: #2088ee;
        }

        .upload-btn:active {
            background-color: #165ba6;
        }

        .upload-btn:disabled {
            background-color: #959595;
        }

        #upload2progress {
        }

        #tipbox-uploading-file-name {
            margin-bottom: 6px;
            font-size: 14px;
        }

    </style>
</head>
<body>
<div class="banner">
    <div class="banner-left">
        <div class="home">
            <a href="#" target="_self" onclick="event.preventDefault();" draggable="false">
                <div id="home-click"><span>FDIndex</span></div>
            </a>
        </div>
        <span class="blank"></span>
        <div class="paths">
            <!--            <div class="path">-->
            <!--                <i class="path-icon"></i>-->
            <!--                <span draggable="false">folder1</span>-->
            <!--            </div>-->
        </div>
    </div>
    <div class="banner-right">
        <div class="banner-button-right">
            <a href="#" target="_self" id="open_drive">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M7.71,3.5L1.15,15L4.58,21L11.13,9.5M9.73,15L6.3,21H19.42L22.85,15M22.28,14L15.42,2H8.58L8.57,2L15.43,14H22.28Z"/>
                </svg>
            </a>
            <a href="#" target="_self" id="switch_theme">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.1L13.73,3.13L12.38,4.26L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.33L10.24,7.36L9.19,8.23L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.93L17.93,10.24C18.6,11.15 19,12.28 19,13.5M14.6,20.08L17.37,18.93L17.13,22.28L14.6,20.08M18.93,17.38L20.08,14.61L22.28,17.15L18.93,17.38M20.08,12.42L18.94,9.64L22.28,9.88L20.08,12.42M9.63,18.93L12.4,20.08L9.87,22.27L9.63,18.93Z"/>
                </svg>
            </a>
        </div>
    </div>
</div>
<div class="body">
    <div class="content">
        <div class="action">
            <button id="upload"><span>上传文件</span></button>
            <button id="new_folder"><span>新建文件夹</span></button>
        </div>
        <div class="list-box">
            <div id="progress-bar">
                <div id="progress" class="sliding-bar-animation"></div>
            </div>
            <div class="list">
                <div class="item file" draggable="false">
                    <div class="item-content" draggable="true">
                        <i class="item-icon"></i>
                        <div class="item-info">
                            <div class="item-name"><span>文件名称</span></div>
                            <div class="item-meta">
                                <div class="item-size"><span>100kb</span></div>
                                <!--                            <div class="item-shared"><span>已共享</span></div>-->
                            </div>
                        </div>
                        <div class="item-action">
                            <button class="item-action-download">
                                <a href="#" target="_self" onclick="event.preventDefault();">
                                    <i class="item-action-download-icon"></i>
                                </a>
                            </button>
                            <button class="item-action-rename">
                                <i class="item-action-rename-icon"></i>
                            </button>
                            <button class="item-action-trash">
                                <i class="item-action-trash-icon"></i>
                            </button>
                            <button class="item-action-delete">
                                <i class="item-action-delete-icon"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="item folder" draggable="false">
                    <a href="#" target="_self" onclick="event.preventDefault();" draggable="false">
                        <div class="item-content" draggable="true">
                            <i class="item-icon"></i>
                            <div class="item-info">
                                <div class="item-name"><span>文件夹名称</span></div>
                                <div class="item-meta">
                                </div>
                            </div>
                            <div class="item-action">
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="tipbox-current-url"><span id="tip-current-url"></span></div>
    </div>
</div>
<div class="overlay hidden" id="dialogOverlay" onclick="closeDialog(event)">
    <div class="dialog-margin-top"></div>
    <div class="dialog" onclick="event.stopPropagation()">
        <div id="upload2select">
            <input type="file" class="file-input" id="fileInput" onchange="handleFileChange(event)">
            <div id="upload-file-name">
                <label for="input-upload-file-name" id="label-upload-file-name">名称</label>
                <input id="input-upload-file-name" type="text" name="keyword"
                       value="" placeholder="" required
                       autofocus autocomplete="off" pattern=""/>
            </div>
            <button class="upload-btn" id="uploadBtn" onclick="uploadFile()" disabled="">上传</button>
            <div id="tipbox-disallowed-upload"><span id="tip-disallowed-upload"></span></div>
        </div>
        <div id="upload2progress">
            <div id="tipbox-uploading-file-name"><span id="tip-uploading-file-name"></span>filename.icc</div>
            <div id="progress-bar-upload">
                <div id="progress-upload" class="sliding-bar-animation"></div>
            </div>
        </div>
    </div>
</div>
<script>  <!--defer-->

const FDIndex_version = null;
const Types = Object.freeze({
    google_drive: 1, cf_d1_kv: 2, deno_mysql: 3, // tidbcloud
});

window.root_attr = {
    "unique": true,
    "id": null,
    "type": null,
    "upload": true,
    "download": null,
    "rename": null,
    "move": null,
    "trash": null,
    "delete": null,
    "btn_goto_drive": null,
    "auto_upload_after_drop": null,
    "disallowed_upload": "",

    "can_trash": null,
    "max_upload_size": -1,

};

window.root_attr.disallowed_upload = window.root_attr.disallowed_upload.split(/[；，、;\s]+/).map(decodeURIComponent).filter(i => i.trim() !== '');
if (window.root_attr.disallowed_upload.length > 0) {
    document.getElementById('tip-disallowed-upload').textContent = `不允许上传：${window.root_attr.disallowed_upload.join(';')}`;
}

const _url = new URL(window.location.href.replace(/#$/, ""));
_url.pathname = "";
document.querySelector('.home a').setAttribute("href", _url.toString());
if (_url.searchParams.get('theme') === "dark") {
    _url.searchParams.delete('theme');
} else {
    _url.searchParams.set('theme', 'dark');
}
document.querySelector('#switch_theme').setAttribute('title', "切换主题");
document.querySelector('#switch_theme').setAttribute("href", _url.toString());


const ItemTypes = Object.freeze({
    file: "file",
    folder: "folder",
    symlink: "symlink",
});

let draggedElement = null;

function toggleAnimation(show,) {
    const progress_bar = document.getElementById("progress-bar");
    const progress = document.getElementById("progress");
    if (!show) {
        progress_bar.style.display = "none";
        progress.style.width = "0%";
        progress.classList.remove("sliding-bar-animation");
    } else {
        progress_bar.style.display = "block";
        progress.style.width = "30%";
        progress.classList.add("sliding-bar-animation");
    }
}

function toggleAnimation_upload(show,) {
    const progress_bar = document.getElementById("progress-bar-upload");
    const progress = document.getElementById("progress-upload");
    if (!show) {
        // progress_bar.style.display = "none";
        progress.style.width = "0%";
        progress.classList.remove("sliding-bar-animation");
    } else {
        // progress_bar.style.display = "block";
        progress.style.width = "30%";
        progress.classList.add("sliding-bar-animation");
    }
}

toggleAnimation(false);
toggleAnimation_upload(false);

function formatBytes(bytes) {
    if (bytes === 0) return "0 B";
    const sizes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    const formattedSize = (bytes / Math.pow(1024, i)).toFixed(1);
    return `${formattedSize} ${sizes[i]}`;
}

function clearFileList() {
    let list_items = document.querySelectorAll('.list > .item'); // div
    list_items.forEach(div => {
        div.remove();
    });
}

function isFile(attr, exactly) {
    if (exactly) {
        return attr.type.toString() === ItemTypes.file;
    }
    return attr.type.toString() === ItemTypes.file || attr.type.toString() === ItemTypes.symlink && attr.symlink_target.type.toString() === ItemTypes.file;
}

function isFolder(attr, exactly) {
    if (exactly) {
        return attr.type.toString() === ItemTypes.folder;
    }
    return attr.type.toString() === ItemTypes.folder || attr.type.toString() === ItemTypes.symlink && attr.symlink_target.type.toString() === ItemTypes.folder;
}

function isSymlink(attr,) {
    return attr.type.toString() === ItemTypes.symlink;
}

function addFile(attr) {
    let container = document.querySelector('.list')
    let _new;
    let _new__content;
    if (isFile(attr, false)) {
        let htmlTemplate = `
<div class="item file" draggable="false">
    <div class="item-content" draggable="${window.root_attr.upload}">
        <i class="item-icon"></i>
        <div class="item-info">
            <div class="item-name"><span>${attr.name}</span></div>
            <div class="item-meta">
                <div class="item-size"><span>${formatBytes(parseInt(attr.size, 10))}</span></div>
            </div>
        </div>
        <div class="item-action">
        </div>
    </div>
</div>
`;
        container.insertAdjacentHTML('beforeend', htmlTemplate);
        _new = container.querySelector('.item:last-child'); // div
        _new__content = _new.querySelector('.item-content'); // div
        let _new__meta = _new__content.querySelector('.item-meta'); // div
        if (attr.shared === true) {
            _new__meta.insertAdjacentHTML('beforeend', `<div class="item-shared"><span>已共享</span></div>`);
        }
        let _new__action = _new__content.querySelector('.item-action'); // div
        if (window.root_attr.download === true) {
            let url = new URL(window.location.href);
            if (!url.pathname.endsWith('/')) {
                url.pathname += "/";
            }
            url.pathname = url.pathname + encodeURIComponent(attr.name);
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-download" title="下载">
    <a href="${url.toString()}" target="_self" onclick="event.preventDefault();">
        <i class="item-action-download-icon"></i>
    </a>
</button>
`);
            _new__action.querySelector('.item-action-download').addEventListener('click', function (e) {
                // console.log(e.target);
                if (e.target.tagName === 'A') { // 多余
                    e.stopPropagation();
                    e.preventDefault();
                    e.target.parentNode.click();
                    return;
                }
                // e.stopImmediatePropagation();
                e.stopPropagation();
                e.preventDefault();
                const a = document.createElement('a');
                a.href = e.target.querySelector("a").href;
                a.download = e.target.closest(".item-content").item_attr.name;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }
        if (window.root_attr.rename === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-rename" title="重命名">
    <i class="item-action-rename-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-rename').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                rename(e);
            });
        }
        if (window.root_attr.trash === true && window.root_attr.can_trash === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-trash" title="移至回收站">
    <i class="item-action-trash-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-trash').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                trash(e);
            });
        }
        if (window.root_attr.delete === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-delete" title="永久删除">
    <i class="item-action-delete-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-delete').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                _delete(e);
            });
        }
    } else if (isFolder(attr, false)) {
        let url = new URL(window.location.href);
        if (!url.pathname.endsWith('/')) {
            url.pathname += "/";
        }
        url.pathname = url.pathname + encodeURIComponent(attr.name) + "/";
        let htmlTemplate = `
<div class="item folder" draggable="false">
    <a href="${url.toString()}" target="_self" onclick="event.preventDefault();" draggable="false">
        <div class="item-content" draggable="${window.root_attr.upload}">
            <i class="item-icon"></i>
            <div class="item-info">
                <div class="item-name"><span>${attr.name}</span></div>
                <div class="item-meta">
                </div>
            </div>
            <div class="item-action">
            </div>
        </div>
    </a>
</div>
`;
        container.insertAdjacentHTML('beforeend', htmlTemplate);
        _new = container.querySelector('.item:last-child'); // div
        _new__content = _new.querySelector('.item-content'); // div
        let _new__meta = _new__content.querySelector('.item-meta'); // div
        if (attr.shared === true) {
            _new__meta.insertAdjacentHTML('beforeend', `<div class="item-shared"><span>已共享</span></div>`);
        }
        let _new__action = _new__content.querySelector('.item-action'); // div
        if (window.root_attr.rename === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-rename" title="重命名">
    <i class="item-action-rename-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-rename').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                rename(e);
            });
        }
        if (window.root_attr.trash === true && window.root_attr.can_trash === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-trash" title="移至回收站">
    <i class="item-action-trash-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-trash').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                trash(e);
            });
        }
        if (window.root_attr.delete === true) {
            _new__action.insertAdjacentHTML('beforeend', `
<button class="item-action-delete" title="永久删除">
    <i class="item-action-delete-icon"></i>
</button>
`);
            _new__action.querySelector('.item-action-delete').addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                _delete(e);
            });
        }
        _new__content.addEventListener('click', function (e) {
            if (e.target.classList.contains('item-content')) {
                if (document.getElementById("progress-bar").style.display !== "none") {
                    return;
                }
                chdir(e);
            }
        });
        _new__content.addEventListener('drop', function (e) {
            if (e.target.classList.contains('item-content')) {
                e.preventDefault();
                e.target.style.backgroundColor = "";
                const parsedObject = JSON.parse(e.dataTransfer.getData("application/json"));
                if (isFolder(e.target.item_attr, false) && window.root_attr.upload && parsedObject.id.toString() !== e.target.item_attr.id.toString()) {
                    let source = findFileItem(parsedObject);
                    move(source, e, parsedObject);
                }
            }
        });
        _new__content.addEventListener('dragover', function (e) {
            if (e.target.classList.contains('item-content')) {
                const parsedObject = JSON.parse(e.dataTransfer.getData("application/json"));
                // console.log("是否允许拖入。", e.target.item_attr);
                if (isFolder(e.target.item_attr, false) && window.root_attr.upload && parsedObject.id.toString() !== e.target.item_attr.id.toString()) {
                    // console.log("允许。",);
                    e.preventDefault();
                    e.target.style.backgroundColor = "rgba(255, 255,0 ,0.4)";
                } else {
                    // console.log("不允许。",);
                    e.target.style.backgroundColor = "";
                }
            }
        });
        _new__content.addEventListener('dragenter', function (e) {
            if (e.target.classList.contains('item-content')) {
                e.preventDefault();
            }
        });
        _new__content.addEventListener('dragleave', function (e) {
            if (e.target.classList.contains('item-content')) {
                e.preventDefault();
                e.target.style.backgroundColor = "";
            }
        });
    }

    if (isSymlink(attr)) {
        _new.classList.add("symlink");
    }
    _new__content.item_attr = attr;
    _new__content.parent_path = document.querySelector('.paths').querySelector('.path:last-child span');
    if (!_new__content.parent_path) {
        _new__content.parent_path = document.querySelector('#home-click');
    }
    _new__content.addEventListener('dragstart', function (e) {
        if (!window.root_attr["move"]) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        if (e.target.classList.contains('item-content')) {
            draggedElement = e;
            // console.log("开始拖拽。", e.target, e.target.item_attr);
            e.dataTransfer.setData("application/json", JSON.stringify(e.target.item_attr));
            e.dataTransfer.effectAllowed = 'move';
        }
    });
    _new__content.addEventListener('dragend', function (e) {
        if (e.target.classList.contains('item-content')) {
        }
        draggedElement = null;
    });
    // console.log('initItem:', _new__content.item_attr, _new__content.parent_path.item_attr.name,);
}

function getCurrentFolderShareLink(attr,) {
    if (window.root_attr.btn_goto_drive !== true) {
        return `#`;
    }
    let id = attr.id === "root" ? window.root_attr.id : attr.id;
    if (window.root_attr.type === Types.google_drive) {
        return `https://drive.google.com/open?id=${id}`;
    } else {
        return `#`;
    }
}

if (window.root_attr.btn_goto_drive !== true) {
    document.querySelector('#open_drive').style.display = 'none';
}
if (window.root_attr.type === Types.google_drive) {
    document.querySelector('#open_drive').setAttribute('title', "在Google网盘打开");
} else {
    document.querySelector('#open_drive').setAttribute('title', "");
}

function customEncode(str) {
    // return encodeURI(str);
    const specialChars = /[\/?#\[\]@!$&'()*+,;=%{}|\\^~\s`"<>：；！？（）]/g;
    // const specialChars = /[\/?#\[\]@&=+%{}|\\^~\s`]/g;
    return str.replace(specialChars, (match) => encodeURIComponent(match));
}

function chdir(e,) {
    clearFileList();
    let home_click = document.querySelector('#home-click'); // div
    let path_spans = document.querySelectorAll('.path span'); // span
    let spansArray = Array.from(path_spans);
    spansArray.unshift(home_click);
    let start_rm = false;
    for (let i = 0; i < spansArray.length; i++) {
        if (start_rm) {
            spansArray.at(i).parentElement.parentElement.remove();
        } else if (e !== null && spansArray[i] === e.target) {
            start_rm = true;
        }
    }
    path_spans = document.querySelectorAll('.path span'); // span
    spansArray = Array.from(path_spans);
    if (e !== null && e.target.classList.contains('item-content')) {
        const _new_path = addPath(e.target.item_attr, spansArray.length === 0 ? home_click : spansArray.at(-1));
        spansArray.push(_new_path);
    }
    if (e !== null && e.target.hasOwnProperty("item_attr")) {
        document.querySelector('#open_drive').setAttribute("href", getCurrentFolderShareLink(e.target.item_attr));
    }
    let path = spansArray.map(element => encodeURIComponent(element.item_attr.name)).join("/");
    if (path.length >= 1) {
        path += "/";
    }
    const currentUrl = new URL(window.location.href);
    currentUrl.pathname = "/" + path;
    const newUrl = currentUrl.toString();
    if (newUrl !== window.location.href.toString()) {
        history.pushState(null, null, currentUrl.toString());
    }

    const _url = new URL(window.location.href.replace(/#$/, ""));

    path = spansArray.map(element => customEncode(element.item_attr.name)).join("/");
    if (path.length >= 1) {
        path += "/";
    }
    currentUrl.pathname = "/";
    currentUrl.search = "";
    // console.log(currentUrl.toString(), path);
    let qsmap = [];
    for (const [key, value] of new URLSearchParams(_url.searchParams)) {
        qsmap.push([key, value]);
    }
    let sqs = qsmap.map(q => `${customEncode(q[0])}=${customEncode(q[1])}`).join("&");
    if (sqs.length >= 1) {
        sqs = "?" + sqs;
    }
    document.getElementById('tip-current-url').textContent = currentUrl.toString() + path + sqs;

    if (_url.searchParams.get('theme') === "dark") {
        _url.searchParams.delete('theme');
    } else {
        _url.searchParams.set('theme', 'dark');
    }
    document.querySelector('#switch_theme').setAttribute("href", _url.toString());

    toggleAnimation(true);
    _chdir(e);
}

async function _chdir(e,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    // console.log('chdir:', e.target.item_attr.name, baseUrl);
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "list",}),
        });
        console.log("chdir:response:", response);
        if (!response.ok) {
            if (response.status === 404) {
                alert(`无效路径：${getFullPath(e.target)}/`,);
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        let data = await response.json();
        console.log("chdir:response:json", data);
        if (e !== null) {
            if (!e.target.hasOwnProperty("item_attr")) {
                e.target.item_attr = {};
            }
            e.target.item_attr["id"] = data["parent"];
        }
        for (let i = 0; i < data["list"].length; i++) {
            addFile(data["list"][i]);
        }
        if (e !== null) {
            document.querySelector('#open_drive').setAttribute("href", getCurrentFolderShareLink(e.target.item_attr));
        }
    } catch (error) {
        console.error("Error sending request:", error);
    }
    toggleAnimation(false);
}

function findFileItem(attr) {
    let di = null;
    document.querySelectorAll('.item-content').forEach((item) => {
        if (item.item_attr.id.toString() === attr.id.toString()) {
            di = item;
        }
    });
    return di;
}

function getFullPath(element) {
    let path = [];
    while (true) {
        if (element == null) {
            break;
        }
        path.push(element.item_attr.name);
        element = element.parent_path;
    }
    path.pop();
    return "/" + path.map(name => encodeURIComponent(name)).reverse().join("/");
}

function getPathCount() {
    return document.querySelectorAll('.path').length;
}

function getPathIndex(element) {
    let pathIndex = -1;
    let i = 0;
    document.querySelectorAll('.path').forEach((item) => {
        if (item === element) {
            pathIndex = i;
        }
        i++;
    });
    return pathIndex;
}

function move(source, e, parsedObject) {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    // console.log("收到拖放数据。", source, parsedObject,);
    if (!source) {
        return;
    }
    if (window.root_attr.upload && isFolder(e.target.item_attr, false)) {
        if (confirm(`把文件${isFolder(source.item_attr, false) ? "夹" : ""}${isSymlink(source.item_attr,) ? "链接" : ""} “${source.item_attr.name}“ 移至 “${e.target.item_attr.name}” ？`)) {
            toggleAnimation(true);
            _move(source, e.target);
        }
    }
}

async function _move(source, to,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "move", source: getFullPath(source), to: getFullPath(to),}),
        });
        console.log("move:response:", response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

    } catch (error) {
        console.error("Error sending request:", error);
    }
    chdir(null);
}

function rename(e,) {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    let item = e.target.closest(".item-content");
    let newName = prompt("重命名：", item.item_attr.name);
    if (!newName) {
        return;
    }
    newName = newName.replace(/[/\\:*?"<>\r\n\t\f]|^[\s]+|[\s]+$/g, '');
    if (newName !== "" && newName !== item.item_attr.name) {
        if (/^\.*$/.test(newName)) {
            return;
        }
        toggleAnimation(true);
        _rename(item, newName);
    }
}

async function _rename(source, name,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "rename", name: name, source: getFullPath(source),}),
        });
        console.log("rename:response:", response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error("Error sending request:", error);
    }
    chdir(null);
}

function trash(e,) {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    let item = e.target.closest(".item-content");
    if (confirm(`把文件${isFolder(item.item_attr, false) ? "夹" : ""}${isSymlink(item.item_attr,) ? "链接" : ""}移至垃圾桶：“${item.item_attr.name}”？`)) {
        toggleAnimation(true);
        _trash(item,);
    }
}

async function _trash(source,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "trash", source: getFullPath(source),}),
        });
        console.log("trash:response:", response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error("Error sending request:", error);
    }
    chdir(null);
}

function _delete(e,) {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    let item = e.target.closest(".item-content");
    if (confirm(`永久删除文件${isFolder(item.item_attr, false) ? "夹" : ""}${isSymlink(item.item_attr,) ? "链接" : ""}：“${item.item_attr.name}”？`)) {
        toggleAnimation(true);
        _delete2(item,);
    }
}

async function _delete2(source,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "delete", source: getFullPath(source),}),
        });
        console.log("delete:response:", response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error("Error sending request:", error);
    }
    chdir(null);
}

async function _newFolder(name,) {
    const baseUrl = new URL(window.location.href.replace(/#$/, ""));
    try {
        const response = await fetch(baseUrl.href, {
            method: "POST", headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({action: "new_folder", name: name,}),
        });
        console.log("new_folder:response:", response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
    } catch (error) {
        console.error("Error sending request:", error);
    }
    chdir(null);
}


function addPath(attr, parent_path) {
    if (typeof attr == "string") {
        const name = attr.toString();
        attr = {
            name: name, type: ItemTypes.folder,
        }
    }
    let container = document.querySelector('.paths')
    const htmlTemplate = `
<div class="path">
    <a href="#" target="_self" onclick="event.preventDefault();" draggable="false">
        <i class="path-icon"></i>
        <span draggable="false">${attr.name}</span>
    </a>
</div>
`;
    container.insertAdjacentHTML('beforeend', htmlTemplate);
    let _new = container.querySelector('.path:last-child span'); // span
    _new.item_attr = attr;
    _new.parent_path = parent_path;

    let _new_a = container.querySelector('.path:last-child a'); // a
    let _url = new URL(window.location.href.replace(/#$/, ""));
    _url.pathname = getFullPath(_new) + "/";
    _new_a.setAttribute("href", _url.toString());

    // console.log('initPath:', _new.item_attr.name, _new.parent_path == null ? null : _new.parent_path.item_attr.name,);
    _new.addEventListener('click', function (event) {
        if (event.target.tagName === 'SPAN') {
            if (document.getElementById("progress-bar").style.display !== "none") {
                return;
            }
            chdir(event);
        }
    });
    _new.addEventListener('drop', function (event) {
        if (event.target.tagName === 'SPAN') {
            event.preventDefault();
            event.target.style.backgroundColor = "";
            const parsedObject = JSON.parse(event.dataTransfer.getData("application/json"));
            if (window.root_attr.upload && getPathIndex(event.target.parentNode.parentNode) + 1 !== getPathCount()) {
                let source = findFileItem(parsedObject);
                move(source, event, parsedObject);
            }
        }
    });
    _new.addEventListener('dragover', function (event) {
        if (event.target.tagName === 'SPAN') {
            const parsedObject = JSON.parse(event.dataTransfer.getData("application/json"));
            if (window.root_attr.upload && getPathIndex(event.target.parentNode.parentNode) + 1 !== getPathCount()) {
                event.preventDefault();
                event.target.style.backgroundColor = "rgba(255, 255,0 ,0.4)";
            } else {
                event.target.style.backgroundColor = "";
            }
        }
    });
    _new.addEventListener('dragenter', function (event) {
        if (event.target.tagName === 'SPAN') {
            event.preventDefault();
        }
    });
    _new.addEventListener('dragleave', function (event) {
        if (event.target.tagName === 'SPAN') {
            event.preventDefault();
            event.target.style.backgroundColor = "";
        }
    });
    return _new;
}


if (window.root_attr.upload === true) {
    document.querySelector('#upload').addEventListener('click', function (e) {
        if (document.getElementById("progress-bar").style.display !== "none") {
            return;
        }
        openDialog();
    });
    document.querySelector('#new_folder').addEventListener('click', function (e) {
        if (document.getElementById("progress-bar").style.display !== "none") {
            return;
        }
        let folderName = prompt("新建文件夹：");
        if (!folderName) {
            return;
        }
        folderName = folderName.replace(/[/\\:*?"<>\r\n\t\f]|^[\s]+|[\s]+$/g, '');
        if (folderName !== "") {
            if (/^\.*$/.test(folderName)) {
                return;
            }
            toggleAnimation(true);
            _newFolder(folderName);
        }
    });
} else {
    document.querySelector('#upload').style.display = 'none';
    document.querySelector('#new_folder').style.display = 'none';
}

let parent_path = document.querySelector('#home-click'); // div
parent_path.item_attr = {name: parent_path.textContent, type: ItemTypes.folder,};
parent_path.parent_path = null;
parent_path.addEventListener('click', function (e) {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    chdir(e);
});
parent_path.addEventListener('drop', function (event) {
    event.preventDefault();
    event.target.style.backgroundColor = "";
    const parsedObject = JSON.parse(event.dataTransfer.getData("application/json"));
    if (window.root_attr.upload && getPathCount() > 0) {
        let source = findFileItem(parsedObject);
        move(source, event, parsedObject);
    }
});
parent_path.addEventListener('dragover', function (event) {
    const parsedObject = JSON.parse(event.dataTransfer.getData("application/json"));
    if (window.root_attr.upload && getPathCount() > 0) {
        event.preventDefault();
        event.target.style.backgroundColor = "rgba(255, 255,0 ,0.4)";
    } else {
        event.target.style.backgroundColor = "";
    }
});
parent_path.addEventListener('dragenter', function (event) {
    event.preventDefault();
});
parent_path.addEventListener('dragleave', function (event) {
    event.preventDefault();
    event.target.style.backgroundColor = "";
});
const pathList = window.location.pathname.split('/').map(decodeURIComponent).filter(part => part !== '');
// console.log('initPath:', parent_path.item_attr.name,);
for (const i of pathList) {
    parent_path = addPath(i, parent_path);
}
parent_path.click();


window.addEventListener('popstate', function (event) {
    location.reload();
});


function openDialog() {
    if (!root_attr.upload) {
        return;
    }
    document.getElementById('dialogOverlay').classList.remove('hidden');
    document.getElementById('fileInput').value = '';
    document.getElementById('input-upload-file-name').value = '';
    toggleUploadButton();
    toggleAnimation_upload(false);
    document.getElementById("tipbox-uploading-file-name").textContent = '';
    document.getElementById("upload2progress").style.display = 'none';
    document.getElementById("upload2select").style.display = 'block';
}

function closeDialog(event) {
    if (document.getElementById("upload2progress").style.display !== "none") {
        return;
    }
    toggleAnimation_upload(false);
    document.getElementById("tipbox-uploading-file-name").textContent = '';
    document.getElementById("upload2select").style.display = 'block';

    const overlay = document.getElementById('dialogOverlay');
    document.getElementById('fileInput').value = '';
    document.getElementById('input-upload-file-name').value = '';
    if (event.target === overlay) {
        overlay.classList.add('hidden');
    }
}

function toggleUploadButton() {
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    // uploadBtn.disabled = fileInput.files.length <= 0;
    uploadBtn.disabled = false;
}

function handleFileChange(event) {
    const file = event.target.files[0];
    toggleUploadButton();
    document.getElementById('input-upload-file-name').value = file.name;
}


function upload(file, name,) {
    toggleAnimation_upload(false);
    document.getElementById("tipbox-uploading-file-name").textContent = name;
    document.getElementById("upload2progress").style.display = 'block';
    document.getElementById("upload2select").style.display = 'none';

    const progress_bar = document.getElementById("progress-bar-upload");
    const progress = document.getElementById("progress-upload");
    progress_bar.style.display = "block";
    progress.style.width = "0%";

    let url = new URL(window.location.href.replace(/#$/, ""));
    if (!url.pathname.endsWith('/')) {
        url.pathname += "/";
    }
    url.pathname = url.pathname + encodeURIComponent(name);
    const xhr = new XMLHttpRequest();
    xhr.open("PUT", url, true);
    xhr.setRequestHeader("Content-Type", file.type);
    xhr.upload.onprogress = function (event) {
        if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            if (percentComplete === 100) {
                console.log(`上传进度: ${percentComplete}%`);
                toggleAnimation_upload(true);
            } else {
                // console.log(`上传进度: ${percentComplete}%`);
                progress.style.width = `${percentComplete}%`;
            }
        }
    };
    xhr.onload = function () {
        if (xhr.status === 200) {
            console.log("文件上传成功");
        } else {
            console.error("文件上传失败", xhr.status, xhr.statusText);
        }
        document.getElementById("upload2progress").style.display = 'none';
        closeDialog({target: document.getElementById('dialogOverlay')});
        chdir(null);
    };
    xhr.onerror = function () {
        console.error("请求错误");
        document.getElementById("upload2progress").style.display = 'none';
        closeDialog({target: document.getElementById('dialogOverlay')});
        // chdir(null);
        location.reload();
    };
    xhr.send(file);
}

function uploadFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (file) {
        let label = document.getElementById('input-upload-file-name');
        label.value = label.value.replace(/[/\\:*?"<>\r\n\t\f]|^[\s]+|[\s]+$/g, '');
        let name = label.value;
        if (name.length === 0) {
            return;
        }
        if (/^\.*$/.test(name)) {
            return;
        }
        for (let disallowedUploadElement of window.root_attr.disallowed_upload) {
            if (!disallowedUploadElement.startsWith('.')) {
                disallowedUploadElement = "." + disallowedUploadElement;
            }
            if (name.endsWith(disallowedUploadElement)) {
                // fileInput.value = '';
                // document.getElementById('input-upload-file-name').value = "";
                alert(document.getElementById('tip-disallowed-upload').textContent);
                return;
            }
        }
        if (root_attr.max_upload_size > 0 && file.size >= root_attr.max_upload_size * 1024 * 1024) {
            alert(`单文件大小限制为${root_attr.max_upload_size}MB。`);
            return;
        }

        upload(file, name);
    } else {
        toggleUploadButton();
    }
}

document.getElementById('dialogOverlay').addEventListener('dragenter', function (event) {
    event.preventDefault();
});
document.getElementById('dialogOverlay').addEventListener('dragover', function (event) {
    event.preventDefault();
});
document.getElementById('dialogOverlay').addEventListener('drop', function (event) {
    event.preventDefault();
});
document.querySelector('body').addEventListener('dragenter', function (event) {
    event.preventDefault();
});
document.querySelector('body').addEventListener('dragover', function (event) {
    event.preventDefault();
});
document.querySelector('body').addEventListener('drop', function (event) {
    event.preventDefault();
});
const list_box = document.querySelector('.list-box');
list_box.addEventListener('dragenter', (event) => {
    if (document.getElementById("progress-bar").style.display !== "none") {
        return;
    }
    if (draggedElement) {
        return;
    }
    event.preventDefault();
    // list_box.style.border = "2px dashed #2088ee";
    openDialog();
});

list_box.addEventListener('dragleave', () => {
    // list_box.style.border = "none";
});

const dialog = document.querySelector('.dialog');
dialog.addEventListener('dragover', (event) => {
    event.preventDefault();
    if (document.getElementById("upload2progress").style.display !== "none") {
        return;
    }
    dialog.style.border = "3px dashed #2088ee";
});

dialog.addEventListener('dragleave', () => {
    dialog.style.border = "3px dashed #00000000";
});

dialog.addEventListener('drop', (event) => {
    event.preventDefault();
    dialog.style.border = "3px dashed #00000000";
    if (document.getElementById("upload2progress").style.display !== "none") {
        return;
    }
    const dataTransferItems = event.dataTransfer.items;
    const validFiles = [];
    for (let i = 0; i < dataTransferItems.length; i++) {
        const item = dataTransferItems[i];
        const entry = item.webkitGetAsEntry && item.webkitGetAsEntry();
        // console.log(item, entry);
        if (entry && entry.isDirectory) {
            continue;
        }
        if (item.kind === 'file') {
            const file = item.getAsFile();
            // console.log(file,);
            if (file) {
                validFiles.push(file);
            }
        }
    }
    const fileInput = document.getElementById('fileInput');
    if (validFiles.length > 0) {
        const dataTransfer = new DataTransfer();
        // validFiles.forEach(file => dataTransfer.items.add(file));
        dataTransfer.items.add(validFiles[0]);
        fileInput.files = dataTransfer.files;
        handleFileChange({target: fileInput});

        if (root_attr.auto_upload_after_drop) {
            document.getElementById('uploadBtn').click();
        }

    } else {
        fileInput.value = '';
        document.getElementById('input-upload-file-name').value = "";
    }
});


</script>
</body>
</html>